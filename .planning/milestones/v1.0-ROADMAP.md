# Milestone v1.0: AVD Health Monitor Refactor

**Status:** SHIPPED 2026-01-16
**Phases:** 1-8
**Total Plans:** 21

## Overview

Comprehensive refactor of the AVD Health Monitor codebase. Starting with the immediate pain (installer issues), then systematically addressing tech debt, improving security, adding test coverage, and implementing new features. Each phase delivered independently verifiable improvements.

## Phases

### Phase 1: Installer Fixes

**Goal**: Application installs without admin privileges, reliable builds
**Depends on**: Nothing (first phase)
**Requirements**: INST-01, INST-02, INST-03, INST-04
**Plans**: 2 plans

Plans:
- [x] 1-01: Tauri config for NSIS per-user and WiX system-wide
- [x] 1-02: CI workflow updates

**Success Criteria** (all TRUE):
1. User can install app without admin prompt (per-user mode)
2. MSI builds successfully in CI
3. NSIS builds successfully in CI
4. Installer offers per-user or system-wide choice

### Phase 2: Component Refactor

**Goal**: SettingsPanel.tsx broken into maintainable components
**Depends on**: Phase 1
**Requirements**: COMP-01, COMP-02, COMP-03, COMP-04, COMP-05, COMP-06
**Plans**: 2 plans

Plans:
- [x] 2-01: Extract ModeSelector, ThresholdSettings components
- [x] 2-02: Extract CustomEndpointManager, ModeEndpointList, FSLogixSettings

**Success Criteria** (all TRUE):
1. SettingsPanel.tsx under 300 lines (achieved: 277 lines)
2. Each settings section is its own component (5 components extracted)
3. All existing functionality preserved
4. No visual regressions

### Phase 3: State Refactor

**Goal**: useAppStore split into domain slices
**Depends on**: Phase 2
**Requirements**: STATE-01, STATE-02, STATE-03, STATE-04, STATE-05
**Plans**: 5 plans

Plans:
- [x] 3-01: Persistence module and slice types
- [x] 3-02: ConfigSlice and UiSlice
- [x] 3-03: EndpointSlice
- [x] 3-04: FslogixSlice
- [x] 3-05: Combine store with slices

**Success Criteria** (all TRUE):
1. Store split into 4 slices (config, endpoint, fslogix, ui)
2. Persistence logic isolated
3. Existing user data migrates correctly
4. No functionality regressions

### Phase 4: Race Conditions

**Goal**: Proper state sequencing, no setTimeout workarounds
**Depends on**: Phase 3
**Requirements**: RACE-01, RACE-02, RACE-03
**Plans**: 2 plans

Plans:
- [x] 4-01: waitForState utility for state sequencing
- [x] 4-02: Remove setTimeout workarounds

**Success Criteria** (all TRUE):
1. Mode switch works without setTimeout
2. Tests trigger only after endpoints loaded
3. No flaky behavior during mode switches

### Phase 5: Type Unification

**Goal**: Single source of truth for shared types
**Depends on**: Phase 4
**Requirements**: TYPE-01, TYPE-02, TYPE-03
**Plans**: 2 plans

Plans:
- [x] 5-01: ts-rs setup and type generation
- [x] 5-02: CI drift detection

**Success Criteria** (all TRUE):
1. Types generated from Rust to TypeScript
2. LatencyThresholds defined once
3. AppConfig defined once
4. Build fails if types drift

### Phase 6: Security

**Goal**: Hardened settings handling and file operations
**Depends on**: Phase 5
**Requirements**: SEC-01, SEC-02, SEC-03
**Plans**: 2 plans

Plans:
- [x] 6-01: faccess for portable detection, path safety module
- [x] 6-02: JSON schema validation

**Success Criteria** (all TRUE):
1. Malformed settings.json rejected with error
2. Portable mode doesn't create test files
3. Path injection prevented in editor invocation

### Phase 7: Testing

**Goal**: Meaningful test coverage for critical paths
**Depends on**: Phase 6
**Requirements**: TEST-01, TEST-02, TEST-03, TEST-04, TEST-05
**Plans**: 3 plans

Plans:
- [x] 7-01: Store slice unit tests
- [x] 7-02: Integration tests (settings roundtrip, mode switching)
- [x] 7-03: CI Rust tests

**Success Criteria** (all TRUE):
1. Settings roundtrip tested (11 tests)
2. Mode switching tested (14 tests)
3. Store slices have unit tests (61 tests)
4. CI runs all tests

### Phase 8: Features

**Goal**: Export/import and offline resilience
**Depends on**: Phase 7
**Requirements**: FEAT-01, FEAT-02, FEAT-03, FEAT-04
**Plans**: 3 plans

Plans:
- [x] 8-01: Settings export/import with native dialogs
- [x] 8-02: CSV history export
- [x] 8-03: Offline detection and banner

**Success Criteria** (all TRUE):
1. User can export settings to file
2. User can import settings from file
3. User can export history to CSV
4. App shows useful state when offline

---

## Milestone Summary

**Key Decisions:**

- NSIS with currentUser mode for per-user install without admin
- WiX MSI kept as system-wide installer for enterprise deployment
- Zustand slice composition with spread operator pattern
- ts-rs 10.1.0 for Rust 1.75+ compatibility
- faccess for portable detection (no test file creation)
- JSON schema validation before deserialize (descriptive errors)

**Issues Resolved:**

- Admin privilege requirement for installation
- SettingsPanel.tsx maintenance burden (940+ lines)
- Monolithic store difficult to test and maintain
- Race conditions causing flaky mode switch behavior
- Rust/TypeScript type drift potential
- Malformed settings.json causing silent failures

**Technical Debt Incurred:**

- Human verification pending for actual CI builds (MSI/NSIS)
- Theme type narrowing in useSettingsSync.ts misses 'nord' and 'cyberpunk' variants (pre-existing)

---

_For current project status, see .planning/ROADMAP.md_
_Archived: 2026-01-16 as part of v1.0 milestone completion_
