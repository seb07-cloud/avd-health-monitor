---
phase: 5-type-unification
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/src/settings.rs
  - src/generated/bindings.ts
  - src/types.ts
autonomous: true

must_haves:
  truths:
    - "LatencyThresholds type is defined once in Rust and generated to TypeScript"
    - "AppConfig type is defined once in Rust and generated to TypeScript"
    - "AppMode enum is defined once in Rust and generated to TypeScript"
    - "Theme is a constrained type (not arbitrary string)"
  artifacts:
    - path: "src-tauri/Cargo.toml"
      provides: "ts-rs dev-dependency"
      contains: "ts-rs"
    - path: "src-tauri/src/settings.rs"
      provides: "Rust types with TS derive macros"
      contains: "#[derive(TS)]"
    - path: "src/generated/bindings.ts"
      provides: "Generated TypeScript types"
      exports: ["LatencyThresholds", "AppConfig", "AppMode", "Theme"]
    - path: "src/types.ts"
      provides: "Re-exported generated types"
      contains: "from './generated/bindings'"
  key_links:
    - from: "src-tauri/src/settings.rs"
      to: "src/generated/bindings.ts"
      via: "cargo test generates types"
      pattern: "ts_rs::export"
    - from: "src/types.ts"
      to: "src/generated/bindings.ts"
      via: "re-export"
      pattern: "export.*from.*generated"
---

<objective>
Unify LatencyThresholds, AppConfig, and AppMode types between Rust and TypeScript using ts-rs.

Purpose: Eliminate type drift risk by generating TypeScript types from Rust source of truth.
Output: Working type generation from Rust to TypeScript, with types re-exported from types.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/5-type-unification/5-RESEARCH.md

@src-tauri/Cargo.toml
@src-tauri/src/settings.rs
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ts-rs and derive macros to Rust types</name>
  <files>
    src-tauri/Cargo.toml
    src-tauri/src/settings.rs
  </files>
  <action>
1. Add ts-rs dev-dependency to Cargo.toml:
   ```toml
   [dev-dependencies]
   ts-rs = "10.1.0"
   ```

2. Create Theme enum in settings.rs (before AppConfig):
   ```rust
   #[derive(Debug, Clone, Serialize, Deserialize, PartialEq, TS)]
   #[ts(export)]
   #[serde(rename_all = "lowercase")]
   pub enum Theme {
       Light,
       Dark,
       Nord,
       Cyberpunk,
       System,
   }

   impl Default for Theme {
       fn default() -> Self {
           Theme::System
       }
   }
   ```

3. Add `use ts_rs::TS;` import at top of settings.rs

4. Add `#[derive(TS)]` and `#[ts(export)]` to these types:
   - `AppMode` - add TS to existing derive, add #[ts(export)]
   - `LatencyThresholds` - add TS to existing derive, add #[ts(export)]
   - `AppConfig` - add TS to existing derive, add #[ts(export)]

5. Update AppConfig.theme field from `String` to `Theme`:
   - Change: `pub theme: String,` to `pub theme: Theme,`
   - Update default_theme function: return `Theme::System` instead of `"system".to_string()`
   - Update Default impl for AppConfig: `theme: Theme::System,`

6. Add ts-rs export test at bottom of settings.rs:
   ```rust
   #[cfg(test)]
   mod ts_export {
       use super::*;

       #[test]
       fn export_bindings() {
           // This test generates TypeScript bindings
           // Run with: TS_RS_EXPORT_DIR=../src/generated cargo test export_bindings
           LatencyThresholds::export().unwrap();
           AppConfig::export().unwrap();
           AppMode::export().unwrap();
           Theme::export().unwrap();
       }
   }
   ```

AVOID: Using ts-rs 11.x (requires Rust 1.88.0, project uses 1.75+).
  </action>
  <verify>
cd src-tauri && cargo check
cd src-tauri && cargo test test_app_mode_serialization
  </verify>
  <done>
Rust compiles with ts-rs derive macros, Theme enum exists, AppConfig uses Theme instead of String.
  </done>
</task>

<task type="auto">
  <name>Task 2: Generate TypeScript types and update imports</name>
  <files>
    src/generated/bindings.ts
    src/types.ts
  </files>
  <action>
1. Create src/generated/ directory

2. Generate TypeScript bindings by running:
   ```bash
   cd src-tauri
   TS_RS_EXPORT_DIR=../src/generated cargo test export_bindings -- --nocapture
   ```

3. ts-rs generates one file per type. Create a combined bindings.ts by concatenating:
   - Read generated AppMode.ts, AppConfig.ts, LatencyThresholds.ts, Theme.ts
   - Combine into single src/generated/bindings.ts with proper exports
   - Add header comment: "// Auto-generated by ts-rs. Do not edit manually."

4. Update src/types.ts:
   - Remove the manual LatencyThresholds interface definition
   - Remove the manual AppConfig interface definition
   - Remove the manual AppMode type definition
   - Add re-exports at top of file:
     ```typescript
     // Re-exported from Rust-generated types (source of truth)
     export type { LatencyThresholds, AppConfig, AppMode, Theme } from './generated/bindings';
     ```
   - Keep all other interfaces that are frontend-only (Endpoint, LatencyResult, EndpointStatus, etc.)

5. Verify the generated types match expectations:
   - AppMode should be: `type AppMode = "sessionhost" | "enduser"`
   - Theme should be: `type Theme = "light" | "dark" | "nord" | "cyberpunk" | "system"`
   - LatencyThresholds should have: excellent, good, warning (all number)
   - AppConfig should have: mode, testInterval, thresholds, theme, etc.

AVOID: Manually editing generated type values - if wrong, fix the Rust source.
  </action>
  <verify>
pnpm exec tsc --noEmit
pnpm test:run
  </verify>
  <done>
TypeScript compiles without errors, types are imported from generated bindings, tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd src-tauri && cargo test` - Rust tests pass including type export
2. `pnpm exec tsc --noEmit` - TypeScript compiles without type errors
3. `pnpm test:run` - Frontend tests pass
4. Grep check: `grep -r "LatencyThresholds" src/` shows imports from generated/bindings
5. Grep check: `grep -r "AppConfig" src/` shows imports from generated/bindings (except types.ts re-export)
</verification>

<success_criteria>
- ts-rs 10.1.0 added to Cargo.toml dev-dependencies
- Theme enum added to settings.rs with TS derive
- AppMode, LatencyThresholds, AppConfig have #[derive(TS)] and #[ts(export)]
- src/generated/bindings.ts contains generated TypeScript types
- src/types.ts re-exports types from generated bindings
- Both Rust and TypeScript compile successfully
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/5-type-unification/5-01-SUMMARY.md`
</output>
